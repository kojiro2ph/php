<?php

#=================================================[½é´ü²½¥ë¡¼¥Á¥ó]====

#¥°¥í¡¼¥Ð¥ëÊÑ¿ô¤Î½é´ü²½
$StdLib 	= "lib/kstd.php";
$SqlLib 	= "lib/ksql.php";
$JcodeLib 	= "lib/jcode.php";
$Mimelib	= "lib/mimew.php";
$Glib		= "lib/hlib.php";
$MainINIFile	= "ini/h.ini";
$ThisFile	= $SCRIPT_NAME;

#---------------------------------------------------------------------

require "$StdLib";	#¥ª¥ê¥¸¥Ê¥ëÉ¸½à¥é¥¤¥Ö¥é¥ê½é´ü²½
require "$SqlLib";	#£Ó£Ñ£Ì¥é¥¤¥Ö¥é¥ê½é´ü²½
#require "$JcodeLib";	#Ê¸»ú¥³¡¼¥ÉÊÑ´¹¥é¥¤¥Ö¥é¥ê½é´ü²½
#require "$Mimelib";	#£Í£É£Í£Å¥é¥¤¥Ö¥é¥ê½é´ü²½
require "$Glib";	#hamada-r¥é¥¤¥Ö¥é¥ê½é´ü²½

Init_Form("euc");
Init_Tag();

$INI = array();
$INI = InitINIData(1,$MainINIFile);

#£Ó£Ñ£Ì½é´ü²½
Init_SQL();

Init_H();

#==================================================================================[¥á¥¤¥ó¥ë¡¼¥Á¥ó]==
#¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú
#====================================================================================================

if(!isset($act)) {
	$act = "home";
}

	$step = GetVal("step");
	$substep = GetVal("substep");



#£Ó£Ñ£ÌÀÜÂ³
ConnectSQL();



#¥Û¡¼¥ë
if($act == "home") {

	$K = ConvVal(ReadFileData("html/user_home.html",3));

} elseif($act == "w") {

	if($step == "") {
		$step = "view";
	}


	if($step == "xxx") {


		$K = ConvVal(ReadFileData("html/user_weeklychoosegroup.html",3));
	} elseif($step == "view") {

		$q_orderby = "";
		$f4	= GetVal("f4");
		$fc 	= GetVal("fc");
		$ar 	= GetVal("ar");
		$al 	= GetVal("al");
		$ac 	= GetVal("ac");
		$gid 	= GetVal("gid");
		$pcode 	= GetVal("pcode");
		$qPosSort = GetVal("qPosSort");
		$s	= GetVal("s");


		if($gid == "") {
			$gid = "101";
		}


		#¥°¥ë¡¼¥×Ì¾¼èÆÀ
		$grpname = GetGrpNameByGrpId($gid);

		#pcode¤Î¼èÆÀ
		if($pcode == "") {
			ExecSQL("SELECT MAX(CONCAT(pyear,pmon,pweek) + 0) AS pcode FROM nettb");
			$pcode = GetValueFromSTH(1,"pcode");
		}

		#Ç¯¡¢·î¡¢½µ¤Î¼èÆÀ
		list($pyear,$pmon,$pweek) = SetPcode($pcode);

		#SELECTÊ¸ºîÀ® ---
		$q_where = " WHERE grpid = '" . $gid . "' AND CONCAT(pyear,pmon,pweek) = '" . $pcode . "' ";

		if($qPosSort != "") {

			if($s == "") {
				$s = "b";
				$qDESC = "DESC";
			} else {
				$s = "";
				$qDESC = "";
			}

			$q_orderby = " ORDER BY $qPosSort $qDESC";
		}

		$q = "SELECT (subid + 0) AS subid,name,net FROM nettb $q_where $q_orderby";


		#¥Ç¥Ð¥°ÍÑ
		#Err_Admin($q);

		ExecSQL($q);

		$qfld = array("subid","name","net");
		SetFieldToArray($qfld);

		$subid 	= GetVal("subid");	#£É£Ä
		$name 	= GetVal("name");	#Ì¾Á°
		$net 	= GetVal("net");	#£Î£å£ô

		$strhtml = "";
		$nettotal = 0;
		for($i = 0; $i < sizeof($subid); $i++) {

			$nettotal = $nettotal + $net[$i];

			$strhtml .= "<tr bgcolor=\"" . Parapara("#EFE8EF") . "\">
					<td $ac>$subid[$i]</td>
					<td $al>$name[$i]</td>
					<td $ar>$net[$i]</td>
				     </tr>
				";
		}


		#Â¾¤Îpcode¤Î¥ê¥ó¥¯Ê¸»úÎóºîÀ® ---

		$q = "SELECT CONCAT(pyear,pmon,pweek) + 0 AS pcodearray FROM nettb GROUP BY pcodearray";
		ExecSQL($q);
		$qfld = array("pcodearray");
		SetFieldToArray($qfld);
		$pcodearray 	= GetVal("pcodearray");	#£Î£å£ô

		$pcodearray2 = array();
		for($i = 0; $i < sizeof($pcodearray); $i++) {
			list($pyear2,$pmon2,$pweek2) = SetPcode($pcodearray[$i]);
			array_push($pcodearray2,$pyear2 . "Ç¯" . ($pmon2 + 0) . "·îÂè" . $pweek2 . "½µ");
		}

		$GLOBALS["pselected"] = $pcode;
		$StrPCodeSelection = MakeSelectionByStrArray(2,"pcode",$pcodearray,$pcodearray2);




		#Â¾¤Î¥°¥ë¡¼¥×¤Î¥ê¥ó¥¯Ê¸»úÎóºîÀ® ---
		$strothersnet = "";
		$gidarray = GetGrpArray("grpid");
		$gnamearray = GetGrpArray("name");

		for($i = 0; $i < sizeof($gidarray); $i++) {

			if($gidarray[$i] == $gid) {
				$strothersnet .= "<FONT CLASS='selectedFont'>$gnamearray[$i]</FONT>¡¡";
			} else {
				$strothersnet .= "<a href=\"$ThisFile?act=w&step=view&gid=$gidarray[$i]&pcode=$pcode\">$gnamearray[$i]</a>¡¡";
			}

			if($i % 5 == 0 and $i != 0) {
				$strothersnet .= "<br> <br>";
			}
		}






		$K = "

			<center>

			 <h3> $pyear Ç¯ $pmon ·î Âè $pweek ½µ¤Î Weekly Net Report </h3> 

			<p>

			<table border=\"1\" cellpadding=\"5\">
			<form name=\"FrmAdmin2\" action=\"$ThisFile\" method=\"post\">
				<tr>
				<td bgcolor=\"#96D698\"> $StrPCodeSelection <input type=\"submit\" value=\"¸«¤ë\"></td>
				<td bgcolor=\"pink\">$f4<b>$nettotal</b>$fc</td>
				</tr>
			<input type=\"hidden\" name=\"act\" value=\"w\">
			<input type=\"hidden\" name=\"step\" value=\"view\">
			<input type=\"hidden\" name=\"gid\" value=\"$gid\">
			</form>
			</table>

			<p>

			<font class=\"sFont\">
			$strothersnet
			</font>

			<p>

			<table class=\"sTable\" border=\"0\" width=\"50%\" cellspacing=\"1\" cellpadding=\"5\" bgcolor='#000000'>
			 <tr bgcolor=\"#FFCC00\">
			  <td width=\"33%\" $ac><a href=\"$ThisFile?act=w&step=view&gid=$gid&pcode=$pcode&qPosSort=subid&s=$s\">IDNO</a></td>
			  <td width=\"33%\" $ac><a href=\"$ThisFile?act=w&step=view&gid=$gid&pcode=$pcode&qPosSort=name&s=$s\">Name</a></td>
			  <td width=\"33%\" $ac><a href=\"$ThisFile?act=w&step=view&gid=$gid&pcode=$pcode&qPosSort=net&s=$s\">Net</a></td>
			 </tr>
			$strhtml
			 <tr bgcolor=\"pink\">
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			  <td $ar> $f4<b>$nettotal</b>$fc </td>
			 </tr>
			</table>

			<p>

			<font class=\"sFont\">
			$strothersnet
			</font>

			</center>
			";

	}



#---------------------------------------
# Bulletin
#---------------------------------------
} elseif($act == "b") {

	Bulletin();

#---------------------------------------
# Monthly
#---------------------------------------
} elseif($act == "m") {

	Monthly();

#---------------------------------------
# Comment
#---------------------------------------
} elseif($act == "comment") {

	Comment();

} else {

}

PB();

#£Ó£Ñ£ÌÀÜÂ³
DisconnectSQL();


exit;

#====================================================================================[¥µ¥Ö¥ë¡¼¥Á¥ó]==
#¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú¡ú
#====================================================================================================

function Bulletin() {

	global $ThisFile,$step,$substep,$pcode,$K,$IsLocal,$com1,$com2;





	#ÊÑ¿ô½é´ü²½ ---
	$q_orderby = "";
	$f4	= GetVal("f4");
	$fc 	= GetVal("fc");
	$ar 	= GetVal("ar");
	$al 	= GetVal("al");
	$ac 	= GetVal("ac");
	$act 	= GetVal("act");

	$kmsg 	= GetVal("kmsg");


	$gid 	= GetVal("gid");
	$sid 	= GetVal("sid");
	$pcode 	= GetVal("pcode");
	$qPosSort = GetVal("qPosSort");
	$s	= GetVal("s");



	if($step == "") {
		$step = "view";
	}


	if($step == "") {
	} elseif($step == "view") {

		#pcode¤Î¼èÆÀ ---
		if($pcode == "") {
			ExecSQL("SELECT MAX(CONCAT(pyear,pmon,pweek) + 0) AS pcode FROM nettb");
			$pcode = GetValueFromSTH(1,"pcode");
		}
		#Ç¯¡¢·î¡¢½µ¤Î¼èÆÀ ---
		list($pyear,$pmon,$pweek) = SetPcode($pcode);


		#WHEREÊ¸ºîÀ® ---
		$q_where = " WHERE
							CONCAT(n.pyear,n.pmon,n.pweek) = '" . $pcode . "'
						AND n.net > 3
					";

		#GROUP BYÊ¸ºîÀ® ---
		$q_groupby = " GROUP BY n.subid";

		#ORDER BYÊ¸ºîÀ® ---
		if($qPosSort != "") {

			if($s == "") {
				$s = "b";
				$qDESC = "DESC";
			} else {
				$s = "";
				$qDESC = "";
			}

			$q_orderby = " ORDER BY $qPosSort $qDESC";
		} else {
			$q_orderby = " ORDER BY net DESC";
		}

		#SELECTÊ¸ºîÀ® ---
		$q = "
			SELECT 
				(n.subid + 0) AS subid
				,n.name AS name
				,n.net AS net
				,ROUND(SUM(n.net),3) AS pnet
			FROM
				nettb n
			$q_where
			$q_groupby
			$q_orderby
		";

		#¥Ç¥Ð¥°ÍÑ ---
		#Err_Admin($q);

		#SQL¼Â¹Ô ---
		ExecSQL($q);

		$qfld = array("subid","name","net");
		SetFieldToArray($qfld);

		$subid 	= GetVal("subid");	#£É£Ä
		#$csubid 	= GetVal("csubid");	#£É£Ä
		$name 	= GetVal("name");	#Ì¾Á°
		$net 	= GetVal("net");	#£Î£å£ô



		#¥³¥á¥ó¥È¤¬¤¢¤ë¤È¤³¤í¤òÈ´¤¯ --- ¤³¤³¤«¤é
		$q = "
			SELECT
				c.subid AS csubid
				,CONCAT(n.pyear,n.pmon,n.pweek) AS cpcode
			FROM nettb n,comtb c
			WHERE
				n.pyear 	= c.pyear
				AND n.pmon 	= c.pmon
				AND n.pweek 	= c.pweek
				AND n.subid	= c.subid
		";
		
		ExecSQL($q);
		
		$qfld = array("csubid","cpcode");
		SetFieldToArray($qfld);
		
		$csubid 	= GetVal("csubid");	#csubid
		$cpcode 	= GetVal("cpcode");	#cpcode

		$hascom1 = array();
		for($i = 0; $i < sizeof($csubid); $i++) {
			#print "$cpcode[$i]_$csubid[$i]<br>";
			$hascom1["$cpcode[$i]_$csubid[$i]"] = "1";
		}


		#¥³¥á¥ó¥È¤¬¤¢¤ë¤È¤³¤í¤òÈ´¤¯ --- ¤³¤³¤Þ¤Ç


		$strhtml = "";
		$nettotal = 0;
		for($i = 0; $i < sizeof($subid); $i++) {

			$nettotal = $nettotal + $net[$i];

			#¥³¥á¥ó¥È¥Þ¡¼¥¯½èÍý
			if(!isset($hascom1[$pcode . "_" . $subid[$i]])) {
				$com1mark = "&nbsp;";
			} else {
				$com1mark = "<a href='$ThisFile?act=comment&m=b&step=v&pcode=$pcode&sid=$subid[$i]'><img src='../images/comfly.gif' border='0'></a>";
			}

			$strhtml .= "<tr bgcolor=\"" . Parapara("#EFE8EF") . "\">
					<td $ac>$subid[$i]</td>
					<td $al>$name[$i]</td>
					<td $ar>$net[$i]</td>
					<td $ac>$com1mark</td>
					<td $ac><a href=\"home.php?act=b&step=w&pcode=$pcode&net=$net[$i]&sid=$subid[$i]\">½ñ¤¯</a></td>
				     </tr>
				";
		}


		#Â¾¤Îpcode¤Î¥ê¥ó¥¯Ê¸»úÎóºîÀ® ---

		$q = "SELECT CONCAT(pyear,pmon,pweek) + 0 AS pcodearray FROM nettb GROUP BY pcodearray";
		ExecSQL($q);
		$qfld = array("pcodearray");
		SetFieldToArray($qfld);
		$pcodearray 	= GetVal("pcodearray");	#£Î£å£ô

		$pcodearray2 = array();
		for($i = 0; $i < sizeof($pcodearray); $i++) {
			list($pyear2,$pmon2,$pweek2) = SetPcode($pcodearray[$i]);
			array_push($pcodearray2,$pyear2 . "Ç¯" . ($pmon2 + 0) . "·îÂè" . $pweek2 . "½µ");
		}

		$GLOBALS["pselected"] = $pcode;
		$StrPCodeSelection = MakeSelectionByStrArray(2,"pcode",$pcodearray,$pcodearray2);


		#Â¾¤Îpcode¤Î¥ê¥ó¥¯Ê¸»úÎóºîÀ® ---

		$q = "SELECT CONCAT(pyear,pmon,pweek) + 0 AS pcodearray FROM nettb GROUP BY pcodearray";
		ExecSQL($q);
		$qfld = array("pcodearray");
		SetFieldToArray($qfld);
		$pcodearray 	= GetVal("pcodearray");	#£Î£å£ô

		$pcodearray2 = array();
		for($i = 0; $i < sizeof($pcodearray); $i++) {
			list($pyear2,$pmon2,$pweek2) = SetPcode($pcodearray[$i]);
			array_push($pcodearray2,$pyear2 . "Ç¯" . ($pmon2 + 0) . "·îÂè" . $pweek2 . "½µ");
		}

		$GLOBALS["pselected"] = $pcode;
		$StrPCodeSelection = MakeSelectionByStrArray(2,"pcode",$pcodearray,$pcodearray2);







		$K = "

			<center>

			<h3> $pyear Ç¯ $pmon ·î Âè $pweek ½µ¤Î Bulletin </h3>

			$kmsg

			<table border=\"1\" cellpadding=\"5\">
			<form name=\"FrmAdmin2\" action=\"$ThisFile\" method=\"post\">
				<tr>
				<td bgcolor=\"#96D698\"> $StrPCodeSelection <input type=\"submit\" value=\"¸«¤ë\"></td>
				<td bgcolor=\"pink\">$f4<b>$nettotal</b>$fc</td>
				</tr>
			<input type=\"hidden\" name=\"act\" value=\"b\">
			<input type=\"hidden\" name=\"step\" value=\"view\">
			</form>
			</table>

			<p>

			<table class=\"sTable\" border=\"0\" width=\"50%\" cellspacing=\"1\" cellpadding=\"5\" bgcolor=\"#000000\">
			 <tr bgcolor=\"#FFCC00\">
			  <td width='20%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=subid&s=$s\">IDNO</a></td>
			  <td width='40%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=name&s=$s\">Name</a></td>
			  <td width='20%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=net&s=$s\">Net</a></td>
			  <td width='10%' $ac>¥³</td>
			  <td width='10%' $ac>½ñ¤¯</td>
			 </tr>
			$strhtml
			 <tr bgcolor=\"pink\">
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			  <td $ar> $f4<b>$nettotal</b>$fc </td>
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			 </tr>
			</table>

			</center>
			";




	}
	elseif($step == "w") {

		#ÊÑ¿ô½é´ü²½ ---
		$femail 	= GetVal("femail");


		#¥á¡¼¥ë¹¹¿·¤Î¾ì¹ç ---
		if($femail != "") {
			$q = "
				UPDATE subtb
				SET email = '$femail'
				WHERE subid = '$sid'
			";

			#¥Ç¥Ð¥°ÍÑ
			#Err_Admin($q);


			ExecSQL($q);



		}




		#¥³¥á¥ó¥È¤ò¼õ¤±¼è¤ë¿Í¤Î¾ðÊó¤ò¥»¥Ã¥È¤¹¤ë
		SetSubDataBySudId($sid);



		$name = GetVal("name");
		$email = GetVal("email");

		#pcodeÀßÄê
		list($GLOBALS["pyear"],$GLOBALS["pmon"],$GLOBALS["pweek"]) = SetPcode($pcode);

		$pyear = $GLOBALS["pyear"];
		$pmon = $GLOBALS["pmon"];
		$pweek = $GLOBALS["pweek"];





		if(!preg_match("/@/",$email)) {

			#$K = "$name ¤µ¤ó¤Î¥á¡¼¥ë¥¢¥É¥ì¥¹¤¬ÀßÄê¤µ¤ì¤Æ¤¤¤Þ¤»¤ó¡£<br> ´ÉÍý²èÌÌ¤Ë¤ÆÀßÄê¤·¤Æ²¼¤µ¤¤¡£";
			$K = ConvVal(ReadFileData("html/user_bulletin_w_inputemail.html",3));

		}
		#½ñ¤­¹þ¤ß¥Õ¥©¡¼¥à ----------------
		elseif($substep == "") {





			#$where = " WHERE repid = 'b' AND pyear = '$pyear' AND pmon = '$pmon' AND pweek = '$pweek' AND subid = '$sid'";

			
			#if(GetRows("SELECT repid FROM comtb $where")) {
			#	#Err_Admin("¤¢¤¢¤¿");
			#	ExecSQL("SELECT com1 FROM comtb $where");
			#	$GLOBALS["com1"] = GetValueFromSTH(1,"com1");
			#}

			if(ComExist(1,'b',$pyear,$pmon,$pweek,$sid)) {
				$GLOBALS["com1"] = GetSpecCom('1','b',$pyear,$pmon,$pweek,$sid);
			}







			#£È£Ô£Í£ÌºîÀ®
			$K = ConvVal(ReadFileData("html/user_bulletin_w_form.html",3));

		}
		#Á÷¿®½èÍý ------------------------
		elseif($substep == "do_write") {

			#¥á¡¼¥ëÁ÷¿®
			if(function_exists("mail") and $IsLocal == 0) {
				#Err_Admin($com1);
				mail($email, JJ("¥á¥Ã¥»¡¼¥¸¤¬¤¢¤ê¤Þ¤¹"), JJ($com1));
			}



			$GLOBALS["subid"] = $sid;
			$GLOBALS["grpid"] = GetGrpIdBySubId($sid);
			$GLOBALS["repid"] = "b";



			$where = " WHERE repid = 'b' AND pyear = '$pyear' AND pmon = '$pmon' AND pweek = '$pweek' AND subid = '$sid'";

			if(ComExist(1,'b',$pyear,$pmon,$pweek,$sid)) {
				UpdateFromHash("comtb",$GLOBALS,$where);
			} else {
				InsertFromHash("comtb",$GLOBALS);
			}



			#£È£Ô£Í£ÌºîÀ®
			$GLOBALS["kmsg"] = Impact("$name ¤µ¤ó¤ËÄÌÃÎ¤·¤Þ¤·¤¿¡£ <p>");

			$GLOBALS["step"] = "";


			Bulletin();

		}
	}
	elseif($step == "v") {

		#¥³¥á¥ó¥È¤ò¼õ¤±¼è¤ë¿Í¤Î¾ðÊó¤ò¥»¥Ã¥È¤¹¤ë
		SetSubDataBySudId($sid);


		#pcodeÀßÄê
		list($GLOBALS["pyear"],$GLOBALS["pmon"],$GLOBALS["pweek"]) = SetPcode($pcode);

		$pyear = $GLOBALS["pyear"];
		$pmon = $GLOBALS["pmon"];
		$pweek = $GLOBALS["pweek"];




		#¥Î¡¼¥Þ¥ë¥â¡¼¥É
		if($substep == "") {

			$where = " WHERE repid = 'b' AND pyear = '$pyear' AND pmon = '$pmon' AND pweek = '$pweek' AND subid = '$sid'";

			
			$qfld = array("com1","com2");
			$q = "SELECT com1,com2 FROM comtb $where";
			ExecSQL($q);

			GetValueFromSTH(3,"",$qfld,$GLOBALS);


			if($GLOBALS["com2"] == "") {
				$GLOBALS["com2"] = "ÊÖ»ö¤Ê¤·";
			}


			$GLOBALS["com1"] = preg_replace("/\n/","<br>",$GLOBALS["com1"]);
			$GLOBALS["com2"] = preg_replace("/\n/","<br>",$GLOBALS["com2"]);



			#£È£Ô£Í£ÌºîÀ®
			$K = ConvVal(ReadFileData("html/user_bulletin_v_comment.html",3));


		}

	}
}





function Monthly() {

	global $ThisFile,$K,$kmsg;


		$q_orderby = "";
		$f4	= GetVal("f4");
		$fc 	= GetVal("fc");
		$ar 	= GetVal("ar");
		$al 	= GetVal("al");
		$ac 	= GetVal("ac");
		$act 	= GetVal("act");
		$gid 	= GetVal("gid");
		$pcode 	= GetVal("pcode");
		$wcnt 	= GetVal("wcnt");
		$qPosSort = GetVal("qPosSort");
		$s	= GetVal("s");




		#pcode¤Î¼èÆÀ
		if($pcode == "") {
			ExecSQL("SELECT MAX(CONCAT(pyear,pmon) + 0) AS pcode FROM nettb");
			$pcode = GetValueFromSTH(1,"pcode");
		}

		#Ç¯¡¢·î¡¢½µ¤Î¼èÆÀ
		$pcode .= "0";
		list($pyear,$pmon,$pweek) = SetPcode($pcode);
		$pcode = $pyear . $pmon;


		#¤½¤Î·î¤Î½µ¤Î¿ô¤ò¼èÆÀ
		if($wcnt == "") {

			#¥Ç¥Ð¥°ÍÑ
			#Err_Admin("SELECT COUNT(*) AS c FROM nettb WHERE CONCAT(pyear,pmon) = '" . $pcode . "' GROUP BY pyear,pmon,pweek");
	
			$wcnt = GetRows("SELECT COUNT(*) AS c FROM nettb WHERE CONCAT(pyear,pmon) = '" . $pcode . "' GROUP BY pyear,pmon,pweek");
	
			#$wcnt = GetValueFromSTH(1,"c");
		}



		#SELECTÊ¸ºîÀ® ---
		$q_where = " WHERE CONCAT(pyear,pmon) = '" . $pcode . "' AND net > " . $wcnt;
		$q_groupby = " GROUP BY subid ";

		if($qPosSort != "") {

			if($s == "") {
				$s = "b";
				$qDESC = "DESC";
			} else {
				$s = "";
				$qDESC = "";
			}

			$q_orderby = " ORDER BY $qPosSort $qDESC";
		} else {
			$q_orderby = " ORDER BY net DESC";
		}

		$q = "SELECT (subid + 0) AS subid,name,net,ROUND(SUM(net),3) AS pnet FROM nettb $q_where $q_groupby $q_orderby";


		#¥Ç¥Ð¥°ÍÑ
		#Err_Admin($q);

		ExecSQL($q);

		$qfld = array("subid","name","net");
		SetFieldToArray($qfld);

		$subid 	= GetVal("subid");	#£É£Ä
		$name 	= GetVal("name");	#Ì¾Á°
		$net 	= GetVal("net");	#£Î£å£ô

		#¥³¥á¥ó¥È¤¬¤¢¤ë¤È¤³¤í¤òÈ´¤¯ --- ¤³¤³¤«¤é ¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£
		$q = "
			SELECT
				c.subid AS csubid
				,CONCAT(n.pyear,n.pmon) AS cpcode
			FROM nettb n,comtb c
			WHERE
				c.repid 	= 'm'
				AND n.pyear 	= c.pyear
				AND n.pmon 	= c.pmon
				AND n.subid	= c.subid
			GROUP BY csubid
		";


		ExecSQL($q);
		
		$qfld = array("csubid","cpcode");
		SetFieldToArray($qfld);

		$csubid 	= GetVal("csubid");	#csubid
		$cpcode 	= GetVal("cpcode");	#cpcode

		$hascom1 = array();
		for($i = 0; $i < sizeof($csubid); $i++) {
			#print "$cpcode[$i]_$csubid[$i]<br>";
			$hascom1["$cpcode[$i]_$csubid[$i]"] = "1";
		}
		#¥³¥á¥ó¥È¤¬¤¢¤ë¤È¤³¤í¤òÈ´¤¯ --- ¤³¤³¤Þ¤Ç ¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£¢£

		$strhtml = "";
		$bigfonts = "<FONT CLASS='F16B'>";
		$bigfontc = "</FONT>";
		$nettotal = 0;
		for($i = 0; $i < sizeof($subid); $i++) {

			$nettotal = $nettotal + $net[$i];

			if($i == $wcnt) {
				$bigfonts = "";
				$bigfontc = "";
				$strtoprank = $strhtml;
				$topnettotal = $nettotal;
				$strhtml = "";
			}


			#¥³¥á¥ó¥È¥Þ¡¼¥¯½èÍý
			if(!isset($hascom1[$pcode . "_" . $subid[$i]])) {
				$com1mark = "&nbsp;";
			} else {
				$com1mark = "<a href='$ThisFile?act=comment&step=v&m=m&pcode=$pcode&sid=$subid[$i]'><img src='../images/comfly.gif' border='0'></a>";
			}


			$strhtml .= "<tr bgcolor=\"" . Parapara("#EFE8EF") . "\">
					<td $ac>$bigfonts$subid[$i]$bigfontc</td>
					<td $al>$bigfonts$name[$i]$bigfontc</td>
					<td $ar>$bigfonts$net[$i]$bigfontc</td>
					<td $ac>$com1mark</td>
					<td $ac><a href=\"home.php?act=comment&step=w&m=m&pcode=$pcode&net=$net[$i]&sid=$subid[$i]\">½ñ¤¯</a></td>
				     </tr>
				";
		}


		#Â¾¤Îpcode¤Î¥ê¥ó¥¯Ê¸»úÎóºîÀ® ---

		#$q = "SELECT CONCAT(pyear,pmon,pweek) + 0 AS pcodearray FROM nettb GROUP BY pcodearray";
		#ExecSQL($q);
		#$qfld = array("pcodearray");
		#SetFieldToArray($qfld);
		#$pcodearray 	= GetVal("pcodearray");	#£Î£å£ô

		#$pcodearray2 = array();
		#for($i = 0; $i < sizeof($pcodearray); $i++) {
		#	list($pyear2,$pmon2,$pweek2) = SetPcode($pcodearray[$i]);
		#	array_push($pcodearray2,$pyear2 . "Ç¯" . ($pmon2 + 0) . "·îÂè" . $pweek2 . "½µ");
		#}

		#$GLOBALS["pselected"] = $pcode;
		#$StrPCodeSelection = MakeSelectionByStrArray(2,"pcode",$pcodearray,$pcodearray2);


		#Â¾¤Îpcode¤Î¥ê¥ó¥¯Ê¸»úÎóºîÀ® ---

		$q = "SELECT CONCAT(pyear,pmon) + 0 AS pcodearray FROM nettb GROUP BY pyear,pmon";
		ExecSQL($q);
		$qfld = array("pcodearray");
		SetFieldToArray($qfld);
		$pcodearray 	= GetVal("pcodearray");	#£Î£å£ô

		$pcodearray2 = array();
		for($i = 0; $i < sizeof($pcodearray); $i++) {
			list($pyear2,$pmon2,$pweek2) = SetPcode($pcodearray[$i] . "0");
			array_push($pcodearray2,$pyear2 . "Ç¯" . ($pmon2 + 0) . "·î");
		}

		$GLOBALS["pselected"] = $pcode;
		$StrPCodeSelection = MakeSelectionByStrArray(2,"pcode",$pcodearray,$pcodearray2);







		$K = "

			<center>

			<h3> $pyear Ç¯ $pmon ·î ¤Î Monthly </h3>


			$kmsg

			<table border=\"1\" cellpadding=\"5\">
			<form name=\"FrmAdmin2\" action=\"$ThisFile\" method=\"post\">
				<tr>
				<td bgcolor=\"#96D698\"> $StrPCodeSelection <input type=\"submit\" value=\"¸«¤ë\"></td>
				<td bgcolor=\"pink\">$f4<b>$nettotal</b>$fc</td>
				</tr>
			<input type=\"hidden\" name=\"act\" value=\"m\">
			<input type=\"hidden\" name=\"step\" value=\"view\">
			</form>
			</table>

			<p>

			<table class=\"sTable\" border=\"0\" width=\"50%\" cellspacing=\"1\" cellpadding=\"5\" bgcolor=\"#000000\">
			 <tr bgcolor=\"#FFCC00\">
			  <td width='20%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=subid&s=$s\">IDNO</a></td>
			  <td width='40%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=name&s=$s\">Name</a></td>
			  <td width='20%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=net&s=$s\">Net</a></td>
			  <td width='10%' $ac>¥³</td>
			  <td width='10%' $ac>½ñ¤¯</td>
			 </tr>
			$strtoprank
			 <tr bgcolor=\"pink\">
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			  <td $ar> $f4<b>$topnettotal</b>$fc </td>
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			 </tr>
			</table>

			<p>

			<table class=\"sTable\" border=\"0\" width=\"50%\" cellspacing=\"1\" cellpadding=\"5\" bgcolor=\"#000000\">
			 <tr bgcolor=\"#FFCC00\">
			  <td width='20%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=subid&s=$s\">IDNO</a></td>
			  <td width='40%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=name&s=$s\">Name</a></td>
			  <td width='20%' $ac><a href=\"$ThisFile?act=$act&step=view&gid=$gid&pcode=$pcode&qPosSort=net&s=$s\">Net</a></td>
			  <td width='10%' $ac>¥³</td>
			  <td width='10%' $ac>½ñ¤¯</td>
			 </tr>
			$strhtml
			 <tr bgcolor=\"pink\">
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			  <td $ar> $f4<b>$nettotal</b>$fc </td>
			  <td> &nbsp; </td>
			  <td> &nbsp; </td>
			 </tr>
			</table>

			<p>

			</center>
			";


}



#---------------------------------------
# ¥³¥á¥ó¥È
#---------------------------------------
function Comment() {

	global $act,$sid,$pcode,$m,$step,$substep,$com1,$K,$IsLocal,$pyear,$pmon,$pweek;


	if($step == "w") {



		#ÊÑ¿ô½é´ü²½ ---
		$femail 	= GetVal("femail");

		#¥á¡¼¥ë¹¹¿·¤Î¾ì¹ç ---
		if($femail != "") {
			$q = "
				UPDATE subtb
				SET email = '$femail'
				WHERE subid = '$sid'
			";

			#¥Ç¥Ð¥°ÍÑ
			#Err_Admin($q);

			ExecSQL($q);

		}

		#¥³¥á¥ó¥È¤ò¼õ¤±¼è¤ë¿Í¤Î¾ðÊó¤ò¥»¥Ã¥È¤¹¤ë ---
		SetSubDataBySudId($sid);

		$name = GetVal("name");
		$email = GetVal("email");


		#pcodeÀßÄê ---
		if($m == "m") {
			$pcode .= "0";
		}
		list($GLOBALS["pyear"],$GLOBALS["pmon"],$GLOBALS["pweek"]) = SetPcode($pcode);
		if($m == "m") {
			$GLOBALS["pweek"] = "";
		}


		$pyear = $GLOBALS["pyear"];
		$pmon = $GLOBALS["pmon"];
		$pweek = $GLOBALS["pweek"];


		#sid¤µ¤ó¤Î¥á¡¼¥ë¥¢¥É¥ì¥¹¤¬¤Ê¤¤¾ì¹ç ---
		if(!preg_match("/@/",$email)) {
			#$K = "$name ¤µ¤ó¤Î¥á¡¼¥ë¥¢¥É¥ì¥¹¤¬ÀßÄê¤µ¤ì¤Æ¤¤¤Þ¤»¤ó¡£<br> ´ÉÍý²èÌÌ¤Ë¤ÆÀßÄê¤·¤Æ²¼¤µ¤¤¡£";
			$K = ConvVal(ReadFileData("html/user_bulletin_w_inputemail.html",3));
		}
		#½ñ¤­¹þ¤ß¥Õ¥©¡¼¥à ----------------
		elseif($substep == "") {


			if(ComExist(1,'b',$pyear,$pmon,$pweek,$sid)) {
				$GLOBALS["com1"] = GetSpecCom('1','b',$pyear,$pmon,$pweek,$sid);
			}

			#£È£Ô£Í£ÌºîÀ®
			$K = ConvVal(ReadFileData("html/user_bulletin_w_form.html",3));

		}
		#Á÷¿®½èÍý ------------------------
		elseif($substep == "do_write") {

			#¥á¡¼¥ëÁ÷¿®
			if(function_exists("mail") and $IsLocal == 0) {
				#Err_Admin($com1);
				mail($email, JJ("¥á¥Ã¥»¡¼¥¸¤¬¤¢¤ê¤Þ¤¹"), JJ($com1));
			}

			$GLOBALS["subid"] = $sid;
			$GLOBALS["grpid"] = GetGrpIdBySubId($sid);
			$GLOBALS["repid"] = $m;

			$where = " WHERE repid = '$m' AND pyear = '$pyear' AND pmon = '$pmon' AND pweek = '$pweek' AND subid = '$sid'";

			if(ComExist(1,'$m',$pyear,$pmon,$pweek,$sid)) {
				UpdateFromHash("comtb",$GLOBALS,$where);
			} else {
				InsertFromHash("comtb",$GLOBALS);
			}

			#£È£Ô£Í£ÌºîÀ®
			$GLOBALS["kmsg"] = Impact("$name ¤µ¤ó¤ËÄÌÃÎ¤·¤Þ¤·¤¿¡£ <p>");

			$GLOBALS["step"] = "";

			if($m == "b") {
				$act = "b";
				Bulletin();
			} elseif($m == "m") {
				$act = "m";
				Monthly();
			}

		}
	}
	elseif($step == "v") {

		#¥³¥á¥ó¥È¤ò¼õ¤±¼è¤ë¿Í¤Î¾ðÊó¤ò¥»¥Ã¥È¤¹¤ë
		SetSubDataBySudId($sid);


		#pcodeÀßÄê ---
		if($m == "m") {
			$pcode .= "0";
		}
		#pcodeÀßÄê
		list($GLOBALS["pyear"],$GLOBALS["pmon"],$GLOBALS["pweek"]) = SetPcode($pcode);
		if($m == "m") {
			$GLOBALS["pweek"] = "";
			$pcode = substr($pcode,0,strlen($pcode) - 1);
		}

		#$pyear = $GLOBALS["pyear"];
		#$pmon = $GLOBALS["pmon"];
		#$pweek = $GLOBALS["pweek"];

		#¥Î¡¼¥Þ¥ë¥â¡¼¥É
		if($substep == "") {

			$where = " WHERE repid = '$m' AND pyear = '$pyear' AND pmon = '$pmon' AND pweek = '$pweek' AND subid = '$sid'";

			
			$qfld = array("com1","com2");
			$q = "SELECT com1,com2 FROM comtb $where";
			ExecSQL($q);

			GetValueFromSTH(3,"",$qfld,$GLOBALS);

			if($GLOBALS["com2"] == "") {
				$GLOBALS["com2"] = "ÊÖ»ö¤Ê¤·";
			}

			$GLOBALS["com1"] = preg_replace("/\n/","<br>",$GLOBALS["com1"]);
			$GLOBALS["com2"] = preg_replace("/\n/","<br>",$GLOBALS["com2"]);

			#£È£Ô£Í£ÌºîÀ®
			$K = ConvVal(ReadFileData("html/user_bulletin_v_comment.html",3));

		}

	}

}














?>